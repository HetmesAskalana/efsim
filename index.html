<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>终末地源石电路修复计算器</title>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z52CM5VFN5"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-Z52CM5VFN5');
    </script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app">
        <h1>终末地源石电路修复计算器</h1>
        <div id="input-area">
            <label for="board-rows">行数</label>
            <input type="number" id="board-rows" min="1" max="10" v-model.number="boardRowsTmp" @keydown.enter.prevent="generateBoard" @change="onRowsChange" />
            <label for="board-cols">列数</label>
            <input type="number" id="board-cols" min="1" max="10" v-model.number="boardColsTmp" @keydown.enter.prevent="generateBoard" />
            <button @click="generateBoard" :disabled="boardRowsTmp < 1 || boardRowsTmp > 10 || boardColsTmp < 1 || boardColsTmp > 10">确定</button>
            <label style="margin-left: 24px; display: flex; align-items: center; gap: 8px; font-weight: 600;">
                <input type="checkbox" v-model="type2Enabled" :disabled="calculateRunning" @change="onType2Toggle" />
                包含蓝色组件
            </label>
            <label style="margin-left: 24px; display: flex; align-items: center; gap: 8px; font-weight: 600;">
                <input type="checkbox" v-model="useButton" :disabled="calculateRunning" @change="onButtonModeToggls" />
                按键输入模式
            </label>
        </div>

        <template v-if="boardGenerated">
            <div id="tool-container" :style="{maxWidth: calculateRunning ? '100vw' : '980px'}">
                <div class="board-wrapper" :style="{gap: '4px'}">
                    <div style="display:flex; flex-direction: column; align-items: flex-end; margin-right: 6px;" :style="{ marginTop: type2Enabled ? (useButton ? '45px' : '30px') : '0' }">
                        <div style="display:flex; gap: 4px; height: 40px;">
                            <div class="corner-box" style="width:40px; height:40px;"></div>
                        </div>
                        <div style="display:flex; gap: 4px;">
                            <div v-if="type2Enabled" :class="useButton ? 'row-buttons-type2' : 'row-inputs-type2'" :style="{gridTemplateRows: `repeat(${boardRows}, 40px)`, display: 'grid', gap: '3px', paddingRight: '6px', marginRight: '8px', borderRight: useButton ? '1px solid #90caf9' : '1px solid #90caf9'}">
                                <template v-if="useButton">
                                    <button v-for="(val, i) in row2Targets"
                                        :key="'rowtarget2-btn-'+i"
                                        class="button-mode-input type2"
                                        @click="incrementTarget('row2', i, boardCols)"
                                        @contextmenu.prevent="decrementTarget('row2', i, boardCols)"
                                        :disabled="calculateRunning"
                                    >
                                        {{ row2Targets[i] }}
                                    </button>
                                </template>
                                <template v-else>
                                    <input type="number" v-for="(val, i) in row2Targets"
                                        :key="'rowtarget2-'+i"
                                        v-model.number="row2Targets[i]"
                                        :min="0"
                                        :max="boardCols"
                                        :disabled="calculateRunning"
                                        @input="validateTarget('row2', i)"
                                    />
                                </template>
                            </div>
                            <div :class="useButton ? 'row-buttons' : 'row-inputs'" :style="{gridTemplateRows: `repeat(${boardRows}, 40px)`}">
                                <template v-if="useButton">
                                    <button v-for="(val, i) in rowTargets"
                                        :key="'rowtarget-btn-'+i"
                                        class="button-mode-input type1"
                                        @click="incrementTarget('row', i, boardCols)"
                                        @contextmenu.prevent="decrementTarget('row', i, boardCols)"
                                        :disabled="calculateRunning"
                                    >
                                        {{ rowTargets[i] }}
                                    </button>
                                </template>
                                <template v-else>
                                    <input type="number" v-for="(val, i) in rowTargets"
                                        :key="'rowtarget-'+i"
                                        v-model.number="rowTargets[i]"
                                        :min="0"
                                        :max="boardCols"
                                        :disabled="calculateRunning"
                                        @input="validateTarget('row', i)"
                                    />
                                </template>
                            </div>
                        </div>
                    </div>

                    <div style="display:flex; flex-direction: column;">
                        <div v-if="type2Enabled" :class="useButton ? 'col-buttons-type2' : 'col-inputs-type2'" :style="{gridTemplateColumns: `repeat(${boardCols}, 40px)`, marginBottom: '8px', paddingBottom: '6px', borderBottom: useButton ? '1px solid #90caf9' : '1px solid #90caf9'}">
                            <template v-if="useButton">
                                <button v-for="(val, j) in col2Targets"
                                    :key="'coltarget2-btn-'+j"
                                    class="button-mode-input type2"
                                    @click="incrementTarget('col2', j, boardRows)"
                                    @contextmenu.prevent="decrementTarget('col2', j, boardRows)"
                                    :disabled="calculateRunning"
                                >
                                    {{ col2Targets[j] }}
                                </button>
                            </template>
                            <template v-else>
                                <input type="number" v-for="(val, j) in col2Targets"
                                    :key="'coltarget2-'+j"
                                    v-model.number="col2Targets[j]"
                                    :min="0"
                                    :max="boardRows"
                                    :disabled="calculateRunning"
                                    @input="validateTarget('col2', j)"
                                />
                            </template>
                        </div>
                        <div :class="useButton ? 'col-buttons' : 'col-inputs'" :style="{gridTemplateColumns: `repeat(${boardCols}, 40px)`}">
                            <template v-if="useButton">
                                <button v-for="(val, j) in colTargets"
                                    :key="'coltarget-btn-'+j"
                                    class="button-mode-input type1"
                                    @click="incrementTarget('col', j, boardRows)"
                                    @contextmenu.prevent="decrementTarget('col', j, boardRows)"
                                    :disabled="calculateRunning"
                                >
                                    {{ colTargets[j] }}
                                </button>
                            </template>
                            <template v-else>
                                <input type="number" v-for="(val, j) in colTargets"
                                    :key="'coltarget-'+j"
                                    v-model.number="colTargets[j]"
                                    :min="0"
                                    :max="boardRows"
                                    :disabled="calculateRunning"
                                    @input="validateTarget('col', j)"
                                />
                            </template>
                        </div>
                        <div id="board" :style="{gridTemplateColumns: `repeat(${boardCols}, 40px)`, gridTemplateRows: `repeat(${boardRows}, 40px)`, width: 40*boardCols + 'px', height: 40*boardRows + 'px'}">
                            <div class="cell"
                                v-for="(cell, idx) in cells"
                                :key="idx"
                                :class="[
                                    { 
                                        disabled: !cell.placed && cell.state === 1, 
                                        locked: !cell.placed && cell.state === 2, 
                                        relocked: !cell.placed && cell.state === 3, 
                                        placed: cell.placed,
                                        type1: cell.placed && cell.state === 2, 
                                        type2: cell.placed && cell.state === 3
                                    },
                                ]"
                                :style="cell.placed ? getCellBorderStyle(cell, idx) : {}"
                                @click="toggleDisableCell(cell)"
                            >
                                <div v-if="cell.placed" class="comp-label">{{ cell.compInstanceId }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="components-panel">
                    <h2>组件列表</h2>
                    <div id="components-scroll-wrapper">
                        <div class="component-item" v-for="(comp, index) in components" :key="'comp-'+index" :style="{gap:'10px'}">
                            <!-- <div style="font-weight: 600; font-size: 1rem; color: #2c3e50; min-width: 60px; user-select:none; display: flex; align-items: center;">
                                {{ comp.name }}
                            </div> -->
                            <div class="comp-icon"
                                :style="{
                                    gridTemplateColumns: `repeat(${comp.sizeCols}, 20px)`,
                                    gridTemplateRows: `repeat(${comp.sizeRows}, 20px)`,
                                    width: comp.sizeCols * 20 + 'px',
                                    height: comp.sizeRows * 20 + 'px',
                                    backgroundColor: '#fff',
                                    boxShadow: '0 0 6px rgba(0,0,0,0.12)',
                                    borderRadius: '8px'
                                }"
                            >
                                <div v-for="r in comp.sizeRows" :key="'row'+r" style="display:contents;">
                                    <div v-for="c in comp.sizeCols" :key="'cell-'+r+'-'+c"
                                        class="cell"
                                        :style="{
                                            width: '20px',
                                            height: '20px',
                                            border: '1px solid #ccc',
                                            borderRadius: '6px',
                                            backgroundColor: comp.shapeSet.has((r-1)+','+(c-1)) ? comp.color : '#fff',
                                            opacity: comp.shapeSet.has((r-1)+','+(c-1)) ? 1 : 0,
                                            cursor: 'default'
                                        }"
                                    ></div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 6px;">
                                <input type="number" min="0" max="99" class="comp-count-input" v-model.number="comp.count" :disabled="calculateRunning" title="绿色组件数量" />
                                <input v-if="type2Enabled" type="number" min="0" max="99" class="comp-count-input" v-model.number="comp.count2" :disabled="calculateRunning" title="蓝色组件数量" :style="{backgroundColor: '#e3f2fd', borderColor: '#90caf9'}" />
                            </div>
                        </div>
                    </div>
                    如果没有您要找的组件请尝试<br/><button
                        class="button-group-button button-reset"
                        @click="refreshComponents"
                        :disabled="calculateRunning"
                        style="font-size: 0.9rem; padding: 6px 16px; vertical-align: middle;"
                    >刷新组件列表</button>
                </div>
            </div>
            <div style="margin-top: 24px; display: flex; justify-content:center; gap: 16px; flex-wrap: wrap;">
                <button
                    class="button-group-button button-start"
                    @click="startCalculation"
                    :disabled="calculateRunning"
                >开始计算</button>
                <button
                    class="button-group-button button-reset"
                    @click="resetAnswer"
                    :disabled="calculateRunning || !boardGenerated"
                >重置答案</button>
                <button
                    class="button-group-button button-reset"
                    @click="resetAll"
                    :disabled="calculateRunning || !boardGenerated"
                >重置全部</button>
                <button
                    class="button-group-button button-reset"
                    @click="exportPreset"
                    :disabled="!answerPlaced || calculateRunning"
                    style="padding: 6px 16px;"
                    >导出当前预设</button>
            </div>
            <div v-if="calculateResultMessage" style="margin-top: 16px; font-weight: 600; font-size: 1.1rem; text-align: center; color: #e74c3c;">
                {{calculateResultMessage}}
            </div>
            <div v-if="boardGenerated && Object.keys(presets).length > 0" style="margin-top: 24px; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto;">
                <h3 style="margin: 0 0 16px 0; text-align: center; font-weight: 700; font-size: 1.2rem; color: #34495e;">导入攻略预设</h3>
                <div style="margin-bottom: 12px;">
                    <input 
                        type="text" 
                        v-model="presetSearchText"
                        @input="onPresetSearchInput"
                        placeholder="搜索预设名称..." 
                        style="width: 100%; padding: 10px 12px; border: 1.8px solid #ccc; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s ease; font-weight: 500;"
                        @focus="(e) => !calculateRunning && (e.target.style.borderColor = '#409eff')"
                        @blur="(e) => e.target.style.borderColor = '#ccc'"
                        :disabled="calculateRunning"
                    />
                </div>
                <div style="border: 1.8px solid #ddd; border-radius: 8px; background: #fafafa; max-height: 240px; overflow-y: auto; margin-bottom: 12px;">
                    <div v-if="presetList.length === 0" style="padding: 20px; text-align: center; color: #999; font-size: 0.95rem;">
                        {{ presetSearchText ? '未找到匹配的预设' : '暂无可用预设' }}
                    </div>
                    <div 
                        v-for="item in presetList" 
                        :key="item.id"
                        @click="selectPreset(item.id)"
                        :style="{
                            padding: '12px 16px',
                            borderBottom: '1px solid #eee',
                            cursor: calculateRunning ? 'default' : 'pointer',
                            backgroundColor: selectedPresetId === item.id ? '#bbdefb' : 'white',
                            transition: 'background-color 0.2s ease',
                            fontWeight: selectedPresetId === item.id ? '600' : '500',
                            color: '#2c3e50',
                            userSelect: 'none',
                        }"
                        @mouseenter="(e) => !calculateRunning && (e.currentTarget.style.backgroundColor = selectedPresetId === item.id ? '#bbdefb' : '#f5f5f5')"
                        @mouseleave="(e) => !calculateRunning && (e.currentTarget.style.backgroundColor = selectedPresetId === item.id ? '#bbdefb' : 'white')"
                    >
                        {{ item.name }}
                    </div>
                </div>
                <div style="margin-top: 12px; display: flex; justify-content:center; gap: 3px; flex-wrap: wrap; font-size: 1rem">
                    <button
                        class="button-group-button button-reset"
                        @click="applyPreset"
                        :disabled="!selectedPresetId || calculateRunning"
                        style="width: 67%;"
                    >
                        应用预设
                    </button>
                    <button
                        class="button-group-button button-reset"
                        @click="refreshPresets"
                        :disabled="calculateRunning"
                    >
                        刷新预设列表
                    </button>
                    <button
                        class="button-group-button button-reset"
                        @click="importPreset"
                        :disabled="calculateRunning"
                        style="width: 100%;"
                    >
                        导入预设
                    </button>
                </div>
            </div>
        </template>
        <div id="author-info" style="position: fixed; right: 12px; bottom: 12px; color: #4a4a4a; font-size: 0.9rem; font-weight: 500; user-select: none; pointer-events: none; z-index: 1000;">
            By HetmesAskalana
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="./main.js"></script>
</body>
</html>
